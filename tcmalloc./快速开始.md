# tcmalloc æ€§èƒ½åˆ†æå·¥å…· - å¿«é€Ÿå¼€å§‹

## ğŸ¯ ä½ å·²ç»æ‹¥æœ‰çš„å·¥å…·

åœ¨ `tcmalloc.` ç›®å½•ä¸‹ï¼Œç°åœ¨æœ‰ä»¥ä¸‹æ€§èƒ½åˆ†æè„šæœ¬ï¼š

| è„šæœ¬åç§° | ç”¨é€” | è€—æ—¶ | æ¨èåœºæ™¯ |
|---------|------|------|---------|
| **quick_perf.sh** | å¿«é€Ÿæ£€æŸ¥ | ~2åˆ†é’Ÿ | æ—¥å¸¸å¼€å‘æµ‹è¯• |
| **valgrind_analysis.sh** | è¯¦ç»†åˆ†æ | ~10åˆ†é’Ÿ | æ·±å…¥æ€§èƒ½è°ƒä¼˜ |
| **compare_perf.sh** | æ€§èƒ½å¯¹æ¯” | ~5åˆ†é’Ÿ | å¯¹æ¯”ä¼˜åŒ–æ•ˆæœ |
| **perf_analysis.sh** | å®Œæ•´åˆ†æ | ~10åˆ†é’Ÿ | éœ€è¦ perf å·¥å…· |

## âš¡ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥èµ°ï¼‰

### ç¬¬1æ­¥ï¼šå¿«é€ŸéªŒè¯

```bash
cd tcmalloc.
./quick_perf.sh
```

è¿™ä¼šå¿«é€Ÿæ£€æŸ¥ï¼š
- âœ… å†…å­˜æ³„æ¼æƒ…å†µ
- âœ… CPU çƒ­ç‚¹å‡½æ•°ï¼ˆå¦‚æœ perf å¯ç”¨ï¼‰
- âœ… åŸºæœ¬æ€§èƒ½æŒ‡æ ‡

### ç¬¬2æ­¥ï¼šè¯¦ç»†åˆ†æï¼ˆæ¨èï¼‰

```bash
./valgrind_analysis.sh
```

è¿™ä¼šç”Ÿæˆå®Œæ•´æŠ¥å‘Šï¼š
- ğŸ“Š å†…å­˜æ³„æ¼è¯¦ç»†æ£€æµ‹
- ğŸ“Š Cache æ€§èƒ½åˆ†æ
- ğŸ“Š å‡½æ•°è°ƒç”¨å›¾
- ğŸ“Š å †å†…å­˜ä½¿ç”¨è¶‹åŠ¿
- ğŸ“Š HTML å¯è§†åŒ–æŠ¥å‘Š

**åˆ†æå®Œæˆåï¼š**
```bash
cd valgrind_results_*
firefox summary.html  # åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹æ¼‚äº®çš„æŠ¥å‘Š
```

### ç¬¬3æ­¥ï¼šæŸ¥çœ‹ç»“æœ

å…³é”®æ–‡ä»¶ï¼š
```bash
# è¿›å…¥ç»“æœç›®å½•
cd valgrind_results_YYYYMMDD_HHMMSS/

# æŸ¥çœ‹æ‘˜è¦
cat README.txt

# æ£€æŸ¥å†…å­˜æ³„æ¼
grep "LEAK SUMMARY" memcheck.txt

# æŸ¥çœ‹çƒ­ç‚¹å‡½æ•°
head -n 50 callgrind_report.txt

# æŸ¥çœ‹ Cache æ€§èƒ½
less cachegrind_report.txt

# å¯è§†åŒ–ï¼ˆéœ€è¦å®‰è£… kcachegrindï¼‰
kcachegrind callgrind.out
```

## ğŸ“Š å¦‚ä½•è§£è¯»ç»“æœ

### 1ï¸âƒ£ å†…å­˜æ³„æ¼ï¼ˆmemcheck.txtï¼‰

```
LEAK SUMMARY:
   definitely lost: 0 bytes in 0 blocks     â† åº”è¯¥æ˜¯ 0
   indirectly lost: 0 bytes in 0 blocks     â† åº”è¯¥æ˜¯ 0
     possibly lost: 0 bytes in 0 blocks     â† åº”è¯¥æ˜¯ 0
   still reachable: XXX bytes in XXX blocks â† å¯ä»¥å¿½ç•¥
```

âœ… **ç›®æ ‡ï¼šå‰ä¸‰é¡¹éƒ½æ˜¯ 0**

### 2ï¸âƒ£ çƒ­ç‚¹å‡½æ•°ï¼ˆcallgrind_report.txtï¼‰

```
Ir                  file:function
8,695,483 (16.04%)  ConcurrentAlloc      â† å æ¯”æœ€é«˜çš„å‡½æ•°
5,482,174 (10.12%)  ThreadCache::Allocate
3,725,428 (6.87%)   CentralCache::Fetch
```

âš ï¸ **å…³æ³¨ï¼šå æ¯” > 5% çš„å‡½æ•°æ˜¯ä¼˜åŒ–é‡ç‚¹**

### 3ï¸âƒ£ Cache æ€§èƒ½ï¼ˆcachegrind_report.txtï¼‰

```
D refs:        500,000,000   æ€»æ•°æ®è®¿é—®
D1 misses:      25,000,000   L1 ç¼“å­˜æœªå‘½ä¸­
LLd misses:      5,000,000   L3 ç¼“å­˜æœªå‘½ä¸­

Cache miss rate = 25,000,000 / 500,000,000 = 5%
```

âœ… **ç›®æ ‡ï¼šL1 miss rate < 5%, LLC miss rate < 2%**

### 4ï¸âƒ£ ç¨‹åºæ€§èƒ½è¾“å‡º

```
===== å•çº¿ç¨‹æ€§èƒ½æµ‹è¯• =====
å¤§å° 64 å­—èŠ‚:
  tcmalloc   alloc: 3.38 ms, free: 10.08 ms
  new/delete alloc: 7.09 ms, free: 6.37 ms
```

ğŸ¯ **å¯¹æ¯”ï¼štcmalloc åº”è¯¥æ¯” new/delete å¿«ï¼ˆè‡³å°‘åœ¨æŸäº›åœºæ™¯ï¼‰**

## ğŸ¨ å¯è§†åŒ–å·¥å…·

### å®‰è£… kcachegrindï¼ˆå¼ºçƒˆæ¨èï¼‰

```bash
sudo apt-get install kcachegrind
```

### ä½¿ç”¨æ–¹æ³•

```bash
cd valgrind_results_*/
kcachegrind callgrind.out
```

**åŠŸèƒ½ï¼š**
- ğŸ” æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ‘
- ğŸ“Š åˆ†ææ—¶é—´å æ¯”
- ğŸ¯ å®šä½æ€§èƒ½ç“¶é¢ˆ
- ğŸ“ˆ å¯è§†åŒ–è°ƒç”¨å…³ç³»

## ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

### Q1: perf ä¸å¯ç”¨

**ç—‡çŠ¶ï¼š**
```
WARNING: perf not found for kernel X.X.X
```

**è§£å†³ï¼š**
```bash
# æ–¹æ¡ˆ1ï¼šä½¿ç”¨ Valgrindï¼ˆå·²ç»å¯ç”¨ï¼‰
./valgrind_analysis.sh

# æ–¹æ¡ˆ2ï¼šå®‰è£…å¯¹åº”å†…æ ¸ç‰ˆæœ¬çš„ perf
sudo apt-get install linux-tools-$(uname -r)
```

### Q2: Valgrind è¿è¡Œå¾ˆæ…¢

**åŸå› ï¼š** Valgrind ä¼šè®©ç¨‹åºæ…¢ 10-50 å€

**è§£å†³ï¼š** è„šæœ¬å·²ç»ä½¿ç”¨è¾ƒå°çš„æµ‹è¯•è§„æ¨¡ï¼ˆ10,000 æ¬¡è¿­ä»£ï¼‰

### Q3: æƒ³è¦æ›´å¿«çš„ç»“æœ

**ä½¿ç”¨å¿«é€Ÿæ¨¡å¼ï¼š**
```bash
./quick_perf.sh  # åªéœ€ 1-2 åˆ†é’Ÿ
```

### Q4: å†…å­˜æ³„æ¼æ˜¾ç¤º "still reachable"

**è¿™æ˜¯æ­£å¸¸çš„ï¼** è¿™äº›æ˜¯ç¨‹åºç»“æŸæ—¶ä»åœ¨ä½¿ç”¨çš„å†…å­˜ï¼Œä¸æ˜¯æ³„æ¼ã€‚

**é‡ç‚¹å…³æ³¨ï¼š** `definitely lost` å’Œ `possibly lost`

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å·¥ä½œæµ

```
1. å»ºç«‹åŸºçº¿
   â””â”€â†’ ./valgrind_analysis.sh
   â””â”€â†’ ä¿å­˜ç»“æœç›®å½•

2. è¯†åˆ«ç“¶é¢ˆ
   â””â”€â†’ æŸ¥çœ‹ callgrind_report.txt
   â””â”€â†’ æ‰¾å‡ºå æ¯” > 5% çš„å‡½æ•°

3. ä¼˜åŒ–ä»£ç 
   â””â”€â†’ æ”¹è¿›ç®—æ³•
   â””â”€â†’ å‡å°‘é”ç«äº‰
   â””â”€â†’ ä¼˜åŒ– Cache è®¿é—®

4. å¯¹æ¯”æµ‹è¯•
   â””â”€â†’ ./valgrind_analysis.sh
   â””â”€â†’ å¯¹æ¯”ä¸¤æ¬¡ç»“æœ

5. é‡å¤ 2-4 ç›´åˆ°æ»¡æ„
```

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡å‚è€ƒ

### å†…å­˜æ–¹é¢
- âœ… æ— å†…å­˜æ³„æ¼
- âœ… å †ä½¿ç”¨å³°å€¼åˆç†
- âœ… æ— å†…å­˜é”™è¯¯

### CPUæ–¹é¢
- âœ… å•çº¿ç¨‹åˆ†é…æ¯” malloc å¿«
- âœ… å¤šçº¿ç¨‹æ‰©å±•æ€§å¥½
- âœ… æ— æ˜æ˜¾çš„é”ç«äº‰

### Cacheæ–¹é¢
- âœ… L1 miss rate < 5%
- âœ… LLC miss rate < 2%
- âœ… æ•°æ®è®¿é—®å±€éƒ¨æ€§å¥½

## ğŸ’¡ å®ç”¨æŠ€å·§

### 1. å¯¹æ¯”ä¸åŒç‰ˆæœ¬

```bash
# ä¼˜åŒ–å‰
./valgrind_analysis.sh
mv valgrind_results_* baseline/

# ä¿®æ”¹ä»£ç ...

# ä¼˜åŒ–å
./valgrind_analysis.sh
mv valgrind_results_* optimized/

# å¯¹æ¯”
diff baseline/callgrind_report.txt optimized/callgrind_report.txt
```

### 2. åªæµ‹è¯•ç‰¹å®šåœºæ™¯

ä¿®æ”¹ `benchmark.cpp` çš„æµ‹è¯•å‚æ•°ï¼š
```cpp
// åªæµ‹è¯•å¤§å—å†…å­˜åˆ†é…
std::vector<size_t> sizes = {4096, 8192, 16384};
```

### 3. ç”Ÿæˆç«ç„°å›¾ï¼ˆé«˜çº§ï¼‰

```bash
# å¦‚æœ perf å¯ç”¨
perf record -F 99 -g ./bench_debug
perf script > out.perf
# ä½¿ç”¨ FlameGraph å·¥å…·ç”Ÿæˆç«ç„°å›¾
```

## ğŸ“š æŸ¥çœ‹æ›´å¤š

è¯¦ç»†æ–‡æ¡£ï¼š
- **æ€§èƒ½åˆ†ææŒ‡å—.md** - å®Œæ•´çš„ä½¿ç”¨è¯´æ˜
- **README.txt** - æ¯æ¬¡åˆ†æçš„ç»“æœè¯´æ˜

## âš™ï¸ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹æµ‹è¯•è§„æ¨¡

ç¼–è¾‘è„šæœ¬ä¸­çš„å‚æ•°ï¼š
```bash
# åœ¨ valgrind_analysis.sh ä¸­
SMALL_N=10000    # æ”¹ä¸ºä½ æƒ³è¦çš„è¿­ä»£æ¬¡æ•°
LARGE_N=100000
```

### æ·»åŠ è‡ªå®šä¹‰åˆ†æ

```bash
# è¿è¡Œè‡ªå®šä¹‰ Valgrind å·¥å…·
valgrind --tool=helgrind ./bench_debug  # æ£€æµ‹æ•°æ®ç«äº‰
valgrind --tool=drd ./bench_debug       # å¦ä¸€ä¸ªçº¿ç¨‹æ£€æµ‹å™¨
```

## ğŸ“ å­¦ä¹ èµ„æº

- [Valgrind ç”¨æˆ·æ‰‹å†Œ](https://valgrind.org/docs/manual/)
- [æ€§èƒ½ä¼˜åŒ–è‰ºæœ¯](https://easyperf.net/blog/)
- [Linux æ€§èƒ½ä¼˜åŒ–](https://www.brendangregg.com/linuxperf.html)

---

**å¿«é€Ÿå‘½ä»¤å¤‡å¿˜å½•ï¼š**
```bash
# æ—¥å¸¸ä½¿ç”¨
./quick_perf.sh                    # å¿«é€Ÿæ£€æŸ¥

# è¯¦ç»†åˆ†æ
./valgrind_analysis.sh             # å®Œæ•´åˆ†æ
cd valgrind_results_*/
firefox summary.html               # æŸ¥çœ‹æŠ¥å‘Š

# å¯è§†åŒ–
kcachegrind callgrind.out         # å‡½æ•°è°ƒç”¨å›¾

# å¯¹æ¯”æµ‹è¯•
./compare_perf.sh                 # æ€§èƒ½å¯¹æ¯”
```

**ç¥ä½ æ€§èƒ½ä¼˜åŒ–é¡ºåˆ©ï¼** ğŸš€

# tcmalloc æ€§èƒ½åˆ†æå·¥å…·é›†

## ğŸ“¦ å·¥å…·æ¸…å•

ä½ çš„ `tcmalloc.` ç›®å½•ç°åœ¨åŒ…å«ä»¥ä¸‹æ€§èƒ½åˆ†æå·¥å…·ï¼š

### ğŸ”§ åˆ†æè„šæœ¬

| æ–‡ä»¶å | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|--------|------|---------|
| `quick_perf.sh` | å¿«é€Ÿæ€§èƒ½æ£€æŸ¥ | æ—¥å¸¸å¼€å‘ï¼Œå¿«é€ŸéªŒè¯ |
| `valgrind_analysis.sh` | å®Œæ•´ Valgrind åˆ†æ | æ·±å…¥æ€§èƒ½è°ƒä¼˜ |
| `compare_perf.sh` | æ€§èƒ½å¯¹æ¯” | å¯¹æ¯”ä¼˜åŒ–å‰åæ•ˆæœ |
| `perf_analysis.sh` | perf + Valgrind å®Œæ•´åˆ†æ | éœ€è¦ perf å·¥å…·æ—¶ä½¿ç”¨ |
| `view_results.sh` | ç»“æœæŸ¥çœ‹å™¨ | æŸ¥çœ‹å·²æœ‰åˆ†æç»“æœ |

### ğŸ“š æ–‡æ¡£

| æ–‡ä»¶å | å†…å®¹ |
|--------|------|
| `å¿«é€Ÿå¼€å§‹.md` | æ–°æ‰‹å…¥é—¨æŒ‡å— |
| `æ€§èƒ½åˆ†ææŒ‡å—.md` | è¯¦ç»†ä½¿ç”¨æ–‡æ¡£ |

### ğŸ—ï¸ ç¼–è¯‘é…ç½®

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Makefile` | å·²æ·»åŠ  `bench_debug` å’Œ `test_debug` ç›®æ ‡ |

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### æ–¹æ¡ˆ Aï¼šåªç”¨ Valgrindï¼ˆæ¨èï¼Œæ— éœ€ perfï¼‰

```bash
# 1. è¿è¡Œå®Œæ•´åˆ†æï¼ˆçº¦10åˆ†é’Ÿï¼‰
./valgrind_analysis.sh

# 2. æŸ¥çœ‹ç»“æœ
./view_results.sh
# é€‰æ‹©é€‰é¡¹æŸ¥çœ‹ä¸åŒçš„åˆ†æç»“æœ

# 3. æˆ–ç›´æ¥æŸ¥çœ‹ HTML æŠ¥å‘Š
firefox valgrind_results_*/summary.html
```

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ perf + Valgrindï¼ˆæœ€å…¨é¢ï¼‰

```bash
# 1. ç¡®ä¿ perf å¯ç”¨
sudo apt-get install linux-tools-$(uname -r)

# 2. è¿è¡Œå®Œæ•´åˆ†æ
./perf_analysis.sh

# 3. æŸ¥çœ‹ç»“æœç›®å½•
cd perf_results_*/
cat README.md
```

### æ–¹æ¡ˆ Cï¼šå¿«é€ŸéªŒè¯ï¼ˆæœ€å¿«ï¼‰

```bash
# åªéœ€ 1-2 åˆ†é’Ÿ
./quick_perf.sh
```

---

## ğŸ“Š ç”Ÿæˆçš„æŠ¥å‘Šè¯´æ˜

### Valgrind åˆ†æç»“æœ

è¿è¡Œ `valgrind_analysis.sh` åï¼Œä¼šç”Ÿæˆï¼š

```
valgrind_results_YYYYMMDD_HHMMSS/
â”œâ”€â”€ summary.html              â­ HTML å¯è§†åŒ–æŠ¥å‘Šï¼ˆæµè§ˆå™¨æŸ¥çœ‹ï¼‰
â”œâ”€â”€ README.txt                ğŸ“ æ–‡æœ¬æ ¼å¼è¯´æ˜
â”œâ”€â”€ memcheck.txt              ğŸ” å†…å­˜æ³„æ¼å’Œé”™è¯¯æ£€æµ‹
â”œâ”€â”€ cachegrind_report.txt     ğŸ’¾ Cache æ€§èƒ½è¯¦ç»†åˆ†æ
â”œâ”€â”€ callgrind_report.txt      ğŸ”¥ å‡½æ•°è°ƒç”¨å’Œçƒ­ç‚¹åˆ†æ
â”œâ”€â”€ massif_report.txt         ğŸ“ˆ å †å†…å­˜ä½¿ç”¨è¶‹åŠ¿
â”œâ”€â”€ callgrind.out             ğŸ¨ å¯ç”¨ kcachegrind å¯è§†åŒ–
â”œâ”€â”€ cachegrind.out            ï¼ˆåŸå§‹æ•°æ®ï¼‰
â””â”€â”€ massif.out                ï¼ˆåŸå§‹æ•°æ®ï¼‰
```

### Perf åˆ†æç»“æœ

è¿è¡Œ `perf_analysis.sh` åï¼Œä¼šç”Ÿæˆï¼š

```
perf_results_YYYYMMDD_HHMMSS/
â”œâ”€â”€ README.md                 ğŸ“ å®Œæ•´è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ perf_report.txt           ğŸ”¥ CPU çƒ­ç‚¹å‡½æ•°
â”œâ”€â”€ perf_stat.txt             ğŸ“Š CPU æ€§èƒ½ç»Ÿè®¡
â”œâ”€â”€ perf_cache.txt            ğŸ’¾ Cache æ€§èƒ½
â”œâ”€â”€ valgrind_memcheck.txt     ğŸ” å†…å­˜æ£€æµ‹
â””â”€â”€ ï¼ˆå…¶ä»– Valgrind æŠ¥å‘Šï¼‰
```

---

## ğŸ¯ å…³é”®æŒ‡æ ‡è§£è¯»

### 1. å†…å­˜æ³„æ¼ï¼ˆç›®æ ‡ï¼š0ï¼‰

```bash
# æŸ¥çœ‹å‘½ä»¤
grep "LEAK SUMMARY" valgrind_results_*/memcheck.txt
```

âœ… **å¥½ï¼š** definitely lost = 0  
âŒ **å·®ï¼š** definitely lost > 0

### 2. çƒ­ç‚¹å‡½æ•°ï¼ˆä¼˜åŒ–è¿™äº›ï¼‰

```bash
# æŸ¥çœ‹å‘½ä»¤
head -n 50 valgrind_results_*/callgrind_report.txt
```

âš ï¸ **å…³æ³¨å æ¯” > 5% çš„å‡½æ•°**

### 3. Cache æ€§èƒ½

```bash
# æŸ¥çœ‹å‘½ä»¤
grep "miss" valgrind_results_*/cachegrind_report.txt
```

âœ… **å¥½ï¼š** miss rate < 5%  
âš ï¸ **ä¸­ï¼š** miss rate 5-10%  
âŒ **å·®ï¼š** miss rate > 10%

### 4. ç¨‹åºæ€§èƒ½

ç›´æ¥çœ‹ç¨‹åºè¾“å‡ºçš„æ€§èƒ½æ•°æ®ï¼š
- tcmalloc åˆ†é…æ—¶é—´
- tcmalloc é‡Šæ”¾æ—¶é—´
- ä¸ new/delete çš„å¯¹æ¯”

---

## ğŸ¨ å¯è§†åŒ–å·¥å…·

### å®‰è£… kcachegrind

```bash
sudo apt-get install kcachegrind
```

### ä½¿ç”¨æ–¹æ³•

```bash
# æ–¹å¼1ï¼šä½¿ç”¨æŸ¥çœ‹å™¨
./view_results.sh
# é€‰æ‹©é€‰é¡¹ 7

# æ–¹å¼2ï¼šç›´æ¥æ‰“å¼€
kcachegrind valgrind_results_*/callgrind.out
```

### kcachegrind åŠŸèƒ½

- ğŸ“Š å¯è§†åŒ–å‡½æ•°è°ƒç”¨æ ‘
- ğŸ¯ æŸ¥çœ‹æ¯ä¸ªå‡½æ•°çš„æ—¶é—´å æ¯”
- ğŸ” è¿½è¸ªè°ƒç”¨é“¾è·¯
- ğŸ“ˆ è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ’¡ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å¿«é€Ÿåˆ†æ
./quick_perf.sh

# è¯¦ç»†åˆ†æï¼ˆæ¨èï¼‰
./valgrind_analysis.sh

# æŸ¥çœ‹æœ€æ–°ç»“æœ
./view_results.sh

# æ‰‹åŠ¨æŸ¥çœ‹å†…å­˜æ³„æ¼
grep "LEAK SUMMARY" valgrind_results_*/memcheck.txt

# æ‰‹åŠ¨æŸ¥çœ‹çƒ­ç‚¹å‡½æ•°
callgrind_annotate valgrind_results_*/callgrind.out | head -n 50

# æ‰‹åŠ¨æŸ¥çœ‹ Cache ç»Ÿè®¡
grep -E "refs|misses" valgrind_results_*/cachegrind_report.txt

# æ‰“å¼€ HTML æŠ¥å‘Š
firefox valgrind_results_*/summary.html

# å¯è§†åŒ–åˆ†æ
kcachegrind valgrind_results_*/callgrind.out

# æ¸…ç†æ—§ç»“æœ
rm -rf valgrind_results_* perf_results_*
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### perf ä¸å¯ç”¨

**é—®é¢˜ï¼š** `WARNING: perf not found for kernel X.X.X`

**è§£å†³æ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ Valgrind åˆ†æï¼ˆæ¨èï¼‰ï¼š
   ```bash
   ./valgrind_analysis.sh
   ```

2. æˆ–å®‰è£… perfï¼š
   ```bash
   sudo apt-get install linux-tools-$(uname -r)
   ```

### Valgrind è¿è¡Œå¤ªæ…¢

**åŸå› ï¼š** Valgrind ä¼šè®©ç¨‹åºæ…¢ 10-50 å€

**è§£å†³æ–¹æ¡ˆï¼š**
- è„šæœ¬å·²ä½¿ç”¨è¾ƒå°æ•°æ®é›†ï¼ˆ10,000 æ¬¡ï¼‰
- è€å¿ƒç­‰å¾…ï¼Œç»“æœå¾ˆæœ‰ä»·å€¼
- æˆ–ä½¿ç”¨ `quick_perf.sh`

### æƒé™é—®é¢˜

```bash
# å¦‚æœè„šæœ¬æ— æ³•æ‰§è¡Œ
chmod +x *.sh
```

### kcachegrind æœªå®‰è£…

```bash
sudo apt-get install kcachegrind
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

æ ¹æ®åˆ†æç»“æœï¼š

### å¦‚æœå‘ç°å†…å­˜æ³„æ¼
1. æŸ¥çœ‹ `memcheck.txt` ä¸­çš„è¯¦ç»†å †æ ˆ
2. æ£€æŸ¥ `new` å’Œ `delete` æ˜¯å¦é…å¯¹
3. æ£€æŸ¥æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨

### å¦‚æœæŸä¸ªå‡½æ•°å ç”¨ > 10% CPU
1. æŸ¥çœ‹è¯¥å‡½æ•°çš„å®ç°
2. è€ƒè™‘ç®—æ³•ä¼˜åŒ–
3. å‡å°‘ä¸å¿…è¦çš„è®¡ç®—

### å¦‚æœ Cache miss rate é«˜
1. ä¼˜åŒ–æ•°æ®ç»“æ„å¸ƒå±€
2. å¢åŠ æ•°æ®è®¿é—®çš„å±€éƒ¨æ€§
3. è€ƒè™‘ä½¿ç”¨å†…å­˜æ± å¯¹é½

### å¦‚æœå¤šçº¿ç¨‹æ€§èƒ½å·®
1. æ£€æŸ¥é”ç«äº‰ï¼ˆcallgrind ä¸­çš„ mutex å‡½æ•°ï¼‰
2. å‡å°é”çš„ç²’åº¦
3. è€ƒè™‘æ— é”æ•°æ®ç»“æ„

---

## ğŸ“š å­¦ä¹ è·¯å¾„

### æ–°æ‰‹
1. é˜…è¯» `å¿«é€Ÿå¼€å§‹.md`
2. è¿è¡Œ `./valgrind_analysis.sh`
3. æŸ¥çœ‹ `summary.html`

### è¿›é˜¶
1. é˜…è¯» `æ€§èƒ½åˆ†ææŒ‡å—.md`
2. å­¦ä¹ ä½¿ç”¨ `kcachegrind`
3. å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½

### é«˜çº§
1. è‡ªå®šä¹‰æµ‹è¯•åœºæ™¯
2. ä½¿ç”¨ç«ç„°å›¾åˆ†æ
3. æ·±å…¥ç ”ç©¶ CPU å¾®æ¶æ„

---

## ğŸ“ æ¨èèµ„æº

- [Valgrind å¿«é€Ÿå…¥é—¨](https://valgrind.org/docs/manual/quick-start.html)
- [æ€§èƒ½ä¼˜åŒ–è‰ºæœ¯](https://easyperf.net/blog/)
- [Brendan Gregg's æ€§èƒ½åšå®¢](https://www.brendangregg.com/blog/)

---

## âœ… æ£€æŸ¥æ¸…å•

ä¼˜åŒ–å®Œæˆå‰ï¼Œç¡®ä¿ï¼š

- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆdefinitely lost = 0ï¼‰
- [ ] æ— å†…å­˜é”™è¯¯ï¼ˆERROR SUMMARY = 0ï¼‰
- [ ] Cache miss rate < 5%
- [ ] çƒ­ç‚¹å‡½æ•°å·²ä¼˜åŒ–
- [ ] å¤šçº¿ç¨‹æ€§èƒ½è‰¯å¥½
- [ ] ä¸æ ‡å‡† malloc å¯¹æ¯”æœ‰ä¼˜åŠ¿

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ–‡æ¡£ï¼š**
   - `å¿«é€Ÿå¼€å§‹.md`
   - `æ€§èƒ½åˆ†ææŒ‡å—.md`

2. **æŸ¥çœ‹è„šæœ¬å†…çš„æ³¨é‡Šï¼š**
   ```bash
   less valgrind_analysis.sh
   ```

3. **æŸ¥çœ‹å·¥å…·å¸®åŠ©ï¼š**
   ```bash
   valgrind --help
   callgrind_annotate --help
   ```

---

**ç¥ä½ çš„ tcmalloc é¡¹ç›®æ€§èƒ½ä¼˜åŒ–é¡ºåˆ©ï¼** ğŸš€

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒæ–‡æ¡£æˆ–æŸ¥çœ‹è„šæœ¬æºç ã€‚
